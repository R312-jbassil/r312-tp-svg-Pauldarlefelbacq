---
import Layout from "../layouts/Layout.astro";
import { ui } from "../i18n/ui";

const locale = Astro.locals.lang as 'en' | 'fr' ?? 'en';
console.log('Locale in index:', locale);
---

<Layout>
	<div class="container mx-auto p-6 max-w-7xl">
		<h1 class="text-2xl font-bold mb-8 text-center">{ui[locale].generator.title}</h1>
		
		<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-full">
			<div class="card bg-base-100 shadow-md">
				<div class="card-body">
					<h2 class="card-title text-lg">{ui[locale].generator.promptLabel}</h2>
					<textarea 
						class="textarea textarea-bordered w-full h-32 resize-none" 
						placeholder={ui[locale].generator.contentPlaceholder}
						id="user-prompt"
					></textarea>
					<div class="card-actions justify-end mt-4">
						<button class="btn btn-primary" id="generate-button">
							{ui[locale].generator.generateButton}
						</button>
						<button class="btn btn-secondary" id="edit-button">
							{ui[locale].generator.editButton}
						</button>
					</div>
				</div>
			</div>

			<div class="card bg-base-100 shadow-md">
				<div class="card-body">
					<h2 class="card-title text-lg">{ui[locale].generator.codePlaceholder}</h2>
					<div class="mockup-code h-64 overflow-y-auto">
						<pre id="svg-output" class="text-sm"><code>{ui[locale].generator.codePlaceholder}</code></pre>
					</div>
				</div>
			</div>

			<div class="card bg-base-100 shadow-md">
				<div class="card-body">
					<h2 class="card-title text-lg">{ui[locale].generator.previewLabel}</h2>
					<div class="border border-base-300 rounded-lg h-64 flex items-center justify-center bg-base-50">
						<div id="svg-container" class="w-full h-full flex items-center justify-center">
							<span class="text-base-content/60">{ui[locale].generator.previewPlaceholder}</span>
						</div>
					</div>
				</div>
				<div class="mt-4" id="save-section" style="display: none;">
					<button class="btn btn-success w-full" id="save-button">
						{ui[locale].generator.saveButton}
					</button>
				</div>
			</div>
		</div>
	</div>
	<script>
		//@ts-nocheck
		const user = JSON.parse(localStorage.getItem("user"));
		let promptList = [];
		let currentSVG = "";
		
		async function generateSVG(prompt, useHistory = false) {
			console.log('Generating SVG for prompt:', prompt);
			
			let requestBody;
			if (useHistory && promptList.length > 0) {
				// Envoyer l'historique complet pour les éditions
				requestBody = { messages: promptList };
			} else {
				// Envoyer juste le prompt pour une nouvelle génération
				requestBody = { prompt };
			}
			
			const res = await fetch('/api/generateSVG', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify(requestBody),
			});
			const data = await res.json();
			return data.svg;
		}

		async function saveSVG(params) {
			const res = await fetch("/api/saveSVG", {
				method: "POST",
				headers: { "Content-Type": "application/json" },
				body: JSON.stringify(params),
			});
			const data = await res.json();
			return data;
		}

		async function handleSubmit() {
			let prompt = "";
			let svgCode = "";
			const promptElement = document.getElementById("user-prompt");
			prompt = promptElement ? promptElement.value : "";
			console.log('submitted: ', prompt);
			promptList.length = 0; 
    		promptList.push({ role: "user", content: prompt });
			const svgContainer = document.getElementById("svg-container");
			let svgOutput = document.getElementById("svg-output");
			const saveSection = document.getElementById("save-section");
			
			svgContainer.innerHTML = `<span class="loading loading-ring loading-xl"></span>`;
			generateButton.disabled = true;
			editButton.disabled = true;
			
			svgCode = await generateSVG(prompt);
			console.log('svgCode reçu: ', svgCode);
			console.log('type de svgCode: ', typeof svgCode);
			console.log('svgCode est-il vide? ', !svgCode || !svgCode.trim());
			
			if (svgCode && svgCode.trim()) {
				// Ajouter la réponse de l'IA à l'historique
				promptList.push({ role: "assistant", content: svgCode });
				
				currentSVG = svgCode;
				console.log('Mise à jour svgOutput avec: ', svgCode.substring(0, 50) + '...');
				const codeElement = svgOutput.querySelector('code');
				if (codeElement) {
					codeElement.textContent = svgCode;
				} else {
					svgOutput.innerHTML = `<code>${svgCode.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</code>`;
				}
				svgContainer.innerHTML = svgCode;
				saveSection.style.display = "block";
				console.log('svgOutput après mise à jour: ', svgOutput.innerHTML.substring(0, 100) + '...');
			} else {
				console.log('SVG vide ou invalide');
				svgContainer.innerHTML = `<span class="text-error">Erreur lors de la génération du SVG</span>`;
				saveSection.style.display = "none";
			}
			
			generateButton.disabled = false;
			editButton.disabled = false;
		}

		const editButton = document.getElementById("edit-button");

		async function handleEdit() {
			let prompt = "";
			let svgCode = "";
			const promptElement = document.getElementById("user-prompt");
			prompt = promptElement ? promptElement.value : "";
			console.log("Prompt soumis : ", prompt);
			
			// Ajout du prompt de l'utilisateur à la liste
			promptList.push({ role: "user", content: prompt });
			
			const svgContainer = document.getElementById("svg-container");
			let svgOutput = document.getElementById("svg-output");
			
			// Afficher un spinner de chargement
			svgContainer.innerHTML = `<span class="loading loading-ring loading-xl"></span>`;
			generateButton.disabled = true;
			editButton.disabled = true;
			
			// Appeler la fonction pour générer le SVG avec l'historique
			svgCode = await generateSVG(prompt, true);
			console.log("Code SVG généré : ", svgCode);
			
			// Ajouter la réponse de l'IA à la liste des prompts
			promptList.push({ role: "assistant", content: svgCode });
			
			if (svgCode && svgCode.trim()) {
				currentSVG = svgCode;
				const codeElement = svgOutput.querySelector('code');
				if (codeElement) {
					codeElement.textContent = svgCode;
				} else {
					svgOutput.innerHTML = `<code>${svgCode.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</code>`;
				}
				svgContainer.innerHTML = svgCode;
				const saveSection = document.getElementById("save-section");
				saveSection.style.display = "block";
			} else {
				svgContainer.innerHTML = `<span class="text-error">Erreur lors de la génération du SVG</span>`;
				saveSection.style.display = "none";
			}
			
			// Réactiver les boutons
			generateButton.disabled = false;
			editButton.disabled = false;
			console.log("Historique des prompts : ", promptList);
		}

		if (editButton) {
			editButton.addEventListener("click", handleEdit);
		}




		const generateButton = document.getElementById("generate-button");
		if (generateButton) {
			generateButton.addEventListener("click", handleSubmit);
		}

		const saveButton = document.getElementById("save-button");
		if (saveButton) {
			saveButton.addEventListener("click", async () => {
				const name = prompt("Enter a name for the SVG:");
				const svgOutput = document.getElementById("svg-output")?.textContent;
				console.log("Saving SVG: ", JSON.stringify(svgOutput));
				
				const params = {
					nom: name,
					code: svgOutput || "<svg></svg>",
					chat_history: JSON.stringify(promptList),
					user: user.id
				};
				await saveSVG(params);
			});
		}
	</script>
</Layout>